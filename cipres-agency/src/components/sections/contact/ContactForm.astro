---
import Button from '@/components/ui/buttons/Button.astro';
import { actions } from 'astro:actions';
import { isInputError } from 'astro:actions';

const result = Astro.getActionResult(actions.send);
const inputErrors = isInputError(result?.error) ? result.error.fields : {};
---

<form class="space-y-4" method="POST" id="contact-form">
  {
    result?.data && (
      <div class="rounded-xl border-2 border-green-500 bg-green-100 p-4 text-green-800">
        <p class="font-semibold">Message sent successfully!</p>
      </div>
    )
  }

  {
    result?.error && !isInputError(result.error) && (
      <div class="rounded-xl border-2 border-red-500 bg-red-100 p-4 text-red-800">
        <p class="font-semibold">{result.error.message}</p>
      </div>
    )
  }

  <!-- Messages container for JS -->
  <div id="form-message" class="hidden"></div>

  <!-- Honeypot field -->
  <input
    type="text"
    name="company"
    style="position:absolute;left:-9999px;width:1px;height:1px;"
    tabindex="-1"
    autocomplete="off"
    aria-hidden="true"
  />

  <!-- Name and Email in Grid -->
  <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
    <!-- Name Field -->
    <div class="space-y-2">
      <input
        type="text"
        id="first-name"
        name="name"
        required
        placeholder="Enter your name"
        class="placeholder:text-accent/80 w-full rounded-lg border border-[#333] bg-[#1a1a1a] px-6 py-4 text-white transition-colors duration-300 outline-none placeholder:text-xl focus:border-[#666]"
      />
      {inputErrors.name && <p class="text-sm text-red-500">{inputErrors.name}</p>}
      <p class="hidden text-sm text-red-500" data-error="name"></p>
    </div>

    <!-- Email Field -->
    <div class="space-y-2">
      <input
        type="email"
        id="email"
        name="email"
        required
        placeholder="Email"
        class="placeholder:text-accent/80 w-full rounded-lg border border-[#333] bg-[#1a1a1a] px-6 py-4 text-white transition-colors duration-300 outline-none placeholder:text-xl focus:border-[#666]"
      />
      {inputErrors.email && <p class="text-sm text-red-500">{inputErrors.email}</p>}
      <p class="hidden text-sm text-red-500" data-error="email"></p>
    </div>
  </div>

  <!-- Message -->
  <div class="space-y-2">
    <textarea
      id="message"
      name="message"
      rows="5"
      required
      placeholder="Message"
      class="placeholder:text-accent/80 w-full resize-none rounded-lg border border-[#333] bg-[#1a1a1a] px-6 py-4 text-white transition-colors duration-300 outline-none placeholder:text-xl focus:border-[#666]"
    ></textarea>
    {inputErrors.message && <p class="text-sm text-red-500">{inputErrors.message}</p>}
    <p class="hidden text-sm text-red-500" data-error="message"></p>
  </div>

  <!-- Submit Button -->
  <Button variant="primary" size="md" class="w-full px-12 md:w-auto" id="submit-btn">
    <span id="btn-text">Submit</span>
    <span id="btn-loader" class="hidden">
      <svg class="inline-block h-5 w-5 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path
          class="opacity-75"
          fill="currentColor"
          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
        ></path>
      </svg>
      Sending...
    </span>
  </Button>
</form>

<script>
  import { actions, isInputError } from 'astro:actions';

  const form = document.getElementById('contact-form') as HTMLFormElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const btnText = document.getElementById('btn-text');
  const btnLoader = document.getElementById('btn-loader');
  const formMessage = document.getElementById('form-message');

  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault(); 

      // Clear previous messages
      if (formMessage) {
        formMessage.classList.add('hidden');
        formMessage.innerHTML = '';
      }

      // Clear field errors
      document.querySelectorAll('[data-error]').forEach((el) => {
        el.classList.add('hidden');
        el.textContent = '';
      });

      // Show loading state
      if (submitBtn && btnText && btnLoader) {
        submitBtn.disabled = true;
        btnText.classList.add('hidden');
        btnLoader.classList.remove('hidden');
      }

      try {
        const formData = new FormData(form);
        const { error } = await actions.send(formData);

        if (error) {
          // Show general error
          if (formMessage) {
            formMessage.classList.remove('hidden');
            formMessage.className = 'p-4 bg-red-100 border-2 border-red-500 rounded-xl text-red-800';
            formMessage.innerHTML = `<p class="font-semibold">Error to send the message.</p>`;
          }

          // If there are field validation errors
          if (isInputError(error)) {
            Object.entries(error.fields).forEach(([field, messages]) => {
              const errorEl = document.querySelector(`[data-error="${field}"]`);
              if (errorEl && Array.isArray(messages)) {
                errorEl.classList.remove('hidden');
                errorEl.textContent = messages[0];
              }
            });
          }
        } else {
          // Show success message
          if (formMessage) {
            formMessage.classList.remove('hidden');
            formMessage.className = 'p-4 bg-green-100 border-2 border-green-500 rounded-xl text-green-800';
            formMessage.innerHTML = '<p class="font-semibold">Message sent successfully!</p>';
          }

          // Reset form
          form.reset();

          // Scroll to success message
          formMessage?.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      } catch (err) {
        console.error('Form submission error:', err);
        if (formMessage) {
          formMessage.classList.remove('hidden');
          formMessage.className = 'p-4 bg-red-100 border-2 border-red-500 rounded-xl text-red-800';
          formMessage.innerHTML = '<p class="font-semibold"> An unexpected error occurred. Please try again.</p>';
        }
      } finally {
        // Restore buttons
        if (submitBtn && btnText && btnLoader) {
          submitBtn.disabled = false;
          btnText.classList.remove('hidden');
          btnLoader.classList.add('hidden');
        }
      }
    });
  }
</script>
